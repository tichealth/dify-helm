# Dify Helm Chart Values for AKS
# Using dify-helm from https://borispolonsky.github.io/dify-helm
# Configured for Azure Kubernetes Service
#
# CPU scaling: Values tuned for D2ads_v6 (2 vCPU). Original baseline was D4s_v5 (4 vCPU);
# all CPU requests/limits = baseline × 0.5 (same ratio across processes).

global:
  edition: "SELF_HOSTED"
  appSecretKey: "PleaseReplaceThisToYourSecretOrUse"
  internalApiKey: ""

# Image versions
image:
  api:
    repository: langgenius/dify-api
    tag: "1.11.2"
    pullPolicy: IfNotPresent
  web:
    repository: langgenius/dify-web
    tag: "1.11.2"
    pullPolicy: IfNotPresent
  sandbox:
    repository: langgenius/dify-sandbox
    tag: "0.2.12"  # Updated to match docker-compose.yaml for Dify 1.11.2
    pullPolicy: IfNotPresent
  proxy:
    repository: nginx
    tag: latest
    pullPolicy: IfNotPresent
  ssrfProxy:
    repository: ubuntu/squid
    tag: latest
    pullPolicy: IfNotPresent
  pluginDaemon:
    repository: langgenius/dify-plugin-daemon
    tag: "0.5.2-local"  # Updated from 0.1.1-local to match docker-compose.yaml for Dify 1.11.2
    pullPolicy: IfNotPresent

# API Configuration
# CPU: D4s_v5 (4 vCPU) values × 0.5 for D2ads_v6 (2 vCPU)
api:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "512Mi"
      cpu: "125m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  persistence:
    enabled: true
    persistentVolumeClaim:
      storageClass: "azurefile"
      accessModes: ReadWriteMany
      size: 5Gi

# Worker Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
worker:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "256Mi"
      cpu: "125m"
    limits:
      memory: "1Gi"
      cpu: "250m"

# Worker Beat Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
beat:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "256Mi"
      cpu: "125m"
    limits:
      memory: "512Mi"
      cpu: "250m"

# Web (Frontend) Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
web:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "512Mi"
      cpu: "125m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# Sandbox Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
sandbox:
  enabled: true
  replicas: 1
  auth:
    apiKey: "dify-sandbox"
  resources:
    requests:
      memory: "512Mi"
      cpu: "125m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# SSRF Proxy Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
ssrfProxy:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "512Mi"
      cpu: "250m"

# Plugin Daemon Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
pluginDaemon:
  enabled: true
  replicas: 1
  auth:
    serverKey: "lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi"
    difyApiKey: "QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1"
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2048Mi"
      cpu: "1000m"
  persistence:
    enabled: true
    persistentVolumeClaim:
      storageClass: "azurefile"
      accessModes: ReadWriteMany
      size: 20Gi

# Proxy (Nginx) Configuration
# CPU: D4s_v5 × 0.5 for D2ads_v6
proxy:
  enabled: true
  replicas: 1
  resources:
    requests:
      memory: "64Mi"
      cpu: "25m"
    limits:
      memory: "256Mi"
      cpu: "100m"

# Service Configuration - Use ClusterIP (Ingress handles external access)
service:
  type: ClusterIP  # Changed from LoadBalancer
  port: 80

# Ingress Configuration - Enable and configure
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # Use "letsencrypt-staging" for testing
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
  hosts:
    - host: dify-dev.tichealth.com.au
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: dify-tls
      hosts:
        - dify-dev.tichealth.com.au

# PostgreSQL Configuration (using Bitnami subchart)
postgresql:
  enabled: true
  global:
    postgresql:
      auth:
        username: "postgres"
        password: "difyai123456"
        database: "dify"
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "125m"  # D4s_v5 × 0.5 for D2ads_v6
      limits:
        memory: "512Mi"
        cpu: "250m"
  readReplicas:
    replicaCount: 0  # Disable read replica for dev (saves CPU)

# Redis Configuration (using Bitnami subchart)
redis:
  enabled: true
  auth:
    password: "difyai123456"
  master:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "50m"   # D4s_v5 × 0.5 for D2ads_v6
      limits:
        memory: "512Mi"
        cpu: "250m"
  replica:
    replicaCount: 0  # Disable replicas for now

# Weaviate disabled (we'll use Qdrant)
weaviate:
  enabled: false

# External Qdrant Configuration
# Note: We need to deploy Qdrant separately or add it as a subchart
# For now, configure as external - we'll deploy Qdrant separately
externalQdrant:
  enabled: true
  endpoint: "http://dify-qdrant:6333"  # Update after Qdrant is deployed
  apiKey: "difyai123456"

# Storage Configuration (using local persistence for now)
externalS3:
  enabled: false

# External Secrets (disabled for now)
externalSecret:
  enabled: false
